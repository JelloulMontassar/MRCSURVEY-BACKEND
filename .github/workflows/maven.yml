name: Java CI with Maven

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Import Secrets from Vault
        id: import-secrets
        uses: hashicorp/vault-action@v1
        with:
          url: https://my-vault-app-f93d58bccb0a.herokuapp.com
          token: hvs.CAESIH_7Pz78iq5WeFKFPVdKkwznjB2MCpAdiMHRtQQvBgX2Gh4KHGh2cy5iUndjWVROYjh1Z05MYkVoT2xQWlFIVUo
          secrets: |
            secret/data/mysql/database host | DB_HOST ;
            secret/data/mysql/database jwt_secret | JWT_SECRET ;
            secret/data/mysql/database password | DB_PASSWORD ;
            secret/data/mysql/database port | DB_PORT ;
            secret/data/mysql/database username | DB_USERNAME

      - name: Validate URI
        run: |
          echo "Validating URI..."
          if [[ ! "https://my-vault-app-f93d58bccb0a.herokuapp.com" =~ ^https:// ]]; then
            echo "Invalid URI: https://my-vault-app-f93d58bccb0a.herokuapp.com"
            exit 1
          fi

      - name: Print and Validate Fetched Secrets
        run: |
          echo "Validating fetched secrets..."
          echo "DB_HOST=${{ env.DB_HOST }}"
          echo "JWT_SECRET=${{ env.JWT_SECRET }}"
          echo "DB_PASSWORD=${{ env.DB_PASSWORD }}"
          echo "DB_PORT=${{ env.DB_PORT }}"
          echo "DB_USERNAME=${{ env.DB_USERNAME }}"

          if [[ -z "${{ env.DB_HOST }}" || -z "${{ env.JWT_SECRET }}" || -z "${{ env.DB_PASSWORD }}" || -z "${{ env.DB_PORT }}" || -z "${{ env.DB_USERNAME }}" ]]; then
            echo "One or more secrets are missing. Validation failed."
            exit 1
          fi

      - name: Build with Maven
        run: mvn -B package --file pom.xml
        env:
          DB_HOST: ${{ env.DB_HOST }}
          JWT_SECRET: ${{ env.JWT_SECRET }}
          DB_PASSWORD: ${{ env.DB_PASSWORD }}
          DB_PORT: ${{ env.DB_PORT }}
          DB_USERNAME: ${{ env.DB_USERNAME }}

      # Optional: Uploads the full dependency graph to GitHub to improve the quality of Dependabot alerts this repository can receive
      - name: Update dependency graph
        uses: advanced-security/maven-dependency-submission-action@571e99aab1055c2e71a1e2309b9691de18d6b7d6
